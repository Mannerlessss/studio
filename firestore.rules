
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    function isAdmin() {
      return request.auth.token.email == 'gagansharma.gs107@gmail.com';
    }

    // Main Users Collection
    match /users/{userId} {
      // CREATE: A user can create their own document.
      allow create: if request.auth.uid == userId;

      // READ, UPDATE: A user can read or update their own data.
      allow read, update: if request.auth.uid == userId;

      // ADMIN: Admin can read any user's document.
      allow get: if isAdmin();
      allow list: if isAdmin();
    }

    // Transactions Subcollection
    match /users/{userId}/transactions/{transactionId} {
      // A user can read and create their own transactions.
      allow read, create: if request.auth.uid == userId;
    }

    // Withdrawals Subcollection
    match /users/{userId}/withdrawals/{withdrawalId} {
        // READ, CREATE: A user can read/create their own withdrawal requests
        allow read, create: if request.auth.uid == userId;
        
        // ADMIN: Admin can read and update any withdrawal request.
        allow get, list, update: if isAdmin();
    }
    
    // Referrals Subcollection
    match /users/{userId}/referrals/{referralId} {
        // READ: User can read their own referral list
        allow read: if request.auth.uid == userId;
        
        // CREATE: A logged-in user can add to another user's referral list.
        // This is needed for the `redeemReferralCode` function.
        allow create: if request.auth != null;
    }

    // Offers Collection
    match /offers/{offerId} {
      // READ: Any authenticated user can read the offers.
      allow read: if request.auth != null;
      
      // ADMIN: Admin can do anything with offers.
      allow write: if isAdmin();
    }
  }
}

    