rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isAdmin() {
      return request.auth != null && request.auth.token.email == "gagansharma.gs107@gmail.com";
    }

    // USERS COLLECTION
    // Admin can list/read all users. Users can create their own doc and read/update it.
    match /users/{userId} {
      allow list, read: if isAdmin();
      allow create: if request.auth.uid == userId;
      allow read, update: if request.auth.uid == userId && !("membership" in request.resource.data); // Prevent user from upgrading themselves

      // WITHDRAWALS SUBCOLLECTION
      // Admin can list/read/update all withdrawals. Users can create/read their own.
      match /withdrawals/{withdrawalId} {
        allow list, read, update: if isAdmin();
        allow create, read: if request.auth.uid == userId;
      }
      
      // OTHER SUBCOLLECTIONS (Transactions, Referrals)
      // Users can manage their own subcollections. Admin has full access.
      match /{subcollection}/{docId} {
        allow read, write: if request.auth.uid == userId || isAdmin();
      }
    }
    
    // OFFERS COLLECTION
    // Admin has full control. All authenticated users can read.
    match /offers/{offerId} {
      allow read, write, create, delete, list: if isAdmin();
      allow get, list: if request.auth != null;
    }
  }
}
