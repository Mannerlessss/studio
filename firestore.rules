
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    function isAuthenticated() {
      return request.auth != null;
    }
    function isAdmin() {
      return isAuthenticated() && request.auth.token.admin == true;
    }

    // USER DATA
    match /users/{userId} {
      // READ: Authenticated users can read all user profiles (needed for referral code lookup)
      allow read: if isAuthenticated();
      
      // WRITE: Users can only create, update, or delete their OWN document.
      allow write: if isOwner(userId);

      // TRANSACTIONS (Subcollection)
      match /transactions/{transactionId} {
        // READ/WRITE: Only the owner of the parent user document can access their transactions.
        allow read, write: if isOwner(userId);
      }
      
      // REFERRALS (Subcollection)
      match /referrals/{referralId} {
         // READ/WRITE: Only the owner can manage their list of referred users.
         allow read, write: if isOwner(userId);
      }

       // WITHDRAWALS (Subcollection)
      match /withdrawals/{withdrawalId} {
         // READ/WRITE: Owner can create, admin can read/update.
         allow read, update: if isAdmin() || isOwner(userId);
         allow create: if isOwner(userId);
         allow delete: if isAdmin();
      }
    }
    
    // OFFER CODES (Managed by Admin)
    match /offers/{offerId} {
      // READ: All authenticated users can read offer codes.
      allow read: if isAuthenticated();
      // WRITE: Only admins can create, update, or delete offer codes.
      allow write: if isAdmin();
    }
    
    // WITHDRAWALS (Collection Group for Admin query)
    match /{path=**}/withdrawals/{withdrawalId} {
      // READ: Admins can read all withdrawal requests across all users.
      allow read: if isAdmin();
    }
  }
}
